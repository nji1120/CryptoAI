# TransformerAgentV2

## 概要
TransformerAgentを改良したバージョン  
改良点は以下  
- TransformerにCLSトークンを追加  
- Envでの利益計算を$N$日後に可変に
- 実際の取引はlongのみとする (学習時はshortも含める)

### CLSトークンについて
---
- #### CLSトークンの必要性
    入力に用いる時系列長さは可変である.  
    また, CLSトークンを利用せずに, transformerから抽出した特徴量を利用すると, 特徴量の次元数が大きくなってしまう.  
    例えば, 特徴量が512次元で, 時間長さが60の場合, 特徴量の数は$512 \times 60 = 30720$となる.  

    そこで, CLSトークンを用いる.
    CLSトークンとは, 時間方向の先頭にconcatする特殊なトークンである.  
    Transformerから抽出したCLSトークンの特徴量のみを利用して学習を行う.  
    こうすることで, CLSトークンに時系列情報が集約される.   
    結果として, 固定長のベクトルで時系列全体の特徴量を利用することが可能となる.

### Envでの利益計算について
---
- #### バージョン1での方法と課題
    バージョン1では利益計算をデイトレードとして行っていた.  
    30～60日分の時系列データに対して, 直近の1日のOHLCデータで利益計算をしていることを示す.  
    考えてみると, この方法では直近データのノイズの影響が大きくなると考えられる.  

    デイトレードの計算では, その日の始値と終値でrewardが計算される.  
    1日あたりのデータの変動は, 入力に使用する30～60日分のデータと比較して小さい.  
    そのため, 小さなノイズに対して, 敏感にrewardが変動してしまう.  

    だからといって, 30日後の利益計算を30日前のデータで行えるとも思えない.  
    なぜなら, 遠い未来を予測するほど, その対応関係を学習するのは困難だからである.

    そのため, 入力データの長さに対して, ちょうどいい利益計算の日数が存在すると考えられる.

- #### v2の変更点と目的
    そこで, v2では利益計算を$N$日後に設定できるようにする.  
    入力データの長さを$T_{past}$, 利益計算の日数を$N=T_{future}$とし, $p=T_{past}/T_{future}$の比率を変えたモデルを学習する.  
    そして, ノイズの影響が少なく, 十分に予測が可能な, ちょうどいい比率を見つける.  
    というのがv2での目的である.

    新規パラメータを以下に示す. 
    |    param     |              description               |
    | :----------: | :------------------------------------: |
    |  $T_{past}$  |            入力データの長さ            |
    | $T_{future}$ |             利益計算の日数             |
    |     $p$      | 入力データの長さと利益計算の日数の比率 |


### 取引をlongのみに
---
- #### 取引をlongのみにする理由
    取引をlongのみにする理由は, 手数料を抑えるためである.  
    デイトレードでは, shortで建玉しても, 1日で決済するため手数料がかからない.  
    しかし, $N$日後に決済する場合, shortの建玉は手数料がかさんでしまう.  
    そのため, 仮にうまいモデルができたとしても, 実利用は困難である.  

- #### 学習ではshortも含める理由
    学習ではshortも含める.  
    これは, 学習時はよりrewardに意味のある数値あある方が, 学習しやすいと考えるからである.  
    shortをなしにすると, actionにstayが入ってくる.  
    そうすると, 動かないほうがいいという局所解に陥りやすくなると考えられる.

## issue
- [x] transformerへのCLSトークンの追加 (2025/5/25完了)  
- [x] envでの利益率計算の変更 (2025/5/25完了)  
- [ ] ~~~agentのactionをlongのみにする~~~ (2025/5/25中止)  
- [x] 学習回す (2025/5/25完了)  